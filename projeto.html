<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Projeto - Movelaria</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="sidebar">
    <h1>RA Movelaria</h1>
    <a href="dashboard.html">Dashboard</a>
    <a href="clientes.html">Clientes</a>
    <a href="financeiro.html">Financeiro</a>
    <a href="#" id="btn-logout">Sair</a>
  </div>
  <div class="sidebar">
    <h1>RA Movelaria</h1>
    <a href="dashboard.html">Dashboard</a>
    <a href="clientes.html">Clientes</a>
    <a href="financeiro.html">Financeiro</a>
    <a href="#" id="btn-logout">Sair</a>
  </div>
  <h2 id="projectTitle" style="margin-left:240px;margin-top:30px;">Projeto</h2>
  <div id="projectScrollContainer">
    <form id="projectFormPage" class="form-scroll">
      <div class="form-flex-container">
        ...existing code...
      </div>
      <div class="modal-actions" style="margin-top:24px;">
        <button type="submit" class="save-btn">Salvar</button>
        <a href="dashboard.html" class="cancel-btn" style="text-align:center;display:inline-block;padding:8px 16px;">Cancelar</a>
      </div>
    </form>
  </div>
          <input type="number" id="total" />
        </div>
        <div class="form-section">
          <h4>Despesas do Projeto</h4>
          <div class="expense-form">
            <input type="text" id="expenseDesc" placeholder="Descrição da Despesa" />
            <input type="number" id="expenseValue" placeholder="Valor (R$)" />
            <div class="expense-row">
              <select id="expenseCategory" class="custom-select">
                <option value="material">Material</option>
                <option value="frete">Frete</option>
                <option value="serviços">Serviços</option>
              </select>
              <input type="date" id="expenseDate" />
            </div>
            <button id="btn-add-expense" type="button">Adicionar Despesa</button>
          </div>
          <ul id="projectExpensesList" class="expenses-list"></ul>
        </div>
        <div class="form-section">
          <h4>Receitas do Projeto</h4>
          <div class="income-form">
            <input type="text" id="incomeDesc" placeholder="Descrição do pagamento" />
            <input type="number" id="incomeValue" placeholder="Valor (R$)" />
            <input type="date" id="incomeDate" />
            <button id="btn-add-income" type="button">Adicionar Receita</button>
          </div>
          <ul id="projectIncomesList" class="incomes-list"></ul>
        </div>
      </div>
      <div class="modal-actions" style="margin-top:24px;">
        <button type="submit" class="save-btn">Salvar</button>
        <a href="dashboard.html" class="cancel-btn" style="text-align:center;display:inline-block;padding:8px 16px;">Cancelar</a>
      </div>
      </form>
    </div>
  </div>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      'https://oncnehknyafxttztjteu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uY25laGtueWFmeHR0enRqdGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MjIzMjEsImV4cCI6MjA3MzI5ODMyMX0.qtqZAi48XqokjQOSn6hFcgVZZRlBk9UcFLeUJjTcA98'
    );
    function getIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }
    async function loadProject(id) {
      const { data, error } = await supabase.from('projetos').select('*').eq('id', id).single();
      if (data) {
        document.getElementById('projectTitle').textContent = `Projeto: ${data.titulo}`;
        document.getElementById('title').value = data.titulo || '';
        document.getElementById('client').value = data.cliente || '';
        document.getElementById('description').value = data.descricao || '';
        document.getElementById('status').value = data.status || 'producao';
        document.getElementById('deadline').value = data.prazo || '';
        document.getElementById('total').value = data.valor_total || '';
      } else {
        alert('Projeto não encontrado!');
        window.location.href = 'dashboard.html';
      }
    }
    async function saveProject(e) {
      e.preventDefault();
      const id = getIdFromUrl();
      const projectData = {
        titulo: document.getElementById('title').value,
        cliente: document.getElementById('client').value,
        descricao: document.getElementById('description').value,
        status: document.getElementById('status').value,
        prazo: document.getElementById('deadline').value,
        valor_total: Number(document.getElementById('total').value),
      };
      const { error } = await supabase.from('projetos').update(projectData).eq('id', id);
      if (!error) {
        alert('Projeto salvo com sucesso!');
        window.location.href = 'dashboard.html';
      } else {
        alert('Erro ao salvar projeto: ' + error.message);
      }
    }
    // Funções para despesas e receitas (reaproveitando do dashboard)
    let projectExpenses = [];
    let projectIncomes = [];

    async function loadExpensesForProject(projetoId) {
      const { data, error } = await supabase
        .from('despesas')
        .select('*')
        .eq('projeto_id', projetoId)
        .order('data', { ascending: false });
      if (!error) {
        projectExpenses = data;
        renderProjectExpenses();
      }
    }

    function renderProjectExpenses() {
      const list = document.getElementById('projectExpensesList');
      list.innerHTML = '';
      if (projectExpenses.length === 0) {
        list.innerHTML = '<li style="text-align:center; color:#888;">Nenhuma despesa adicionada</li>';
        return;
      }
      projectExpenses.forEach((e) => {
        const item = document.createElement('li');
        const formattedDate = e.data ? new Date(e.data).toLocaleDateString() : '';
        item.innerHTML = `
          <div>
            <strong>${e.descricao}</strong> 
            <span class="category">${e.categoria}</span>
            <br><small>${formattedDate}</small>
          </div>
          <span class="value">R$${e.valor.toFixed(2)}</span>
        `;
        list.appendChild(item);
      });
    }

    async function addExpenseToProject() {
      const descricao = document.getElementById('expenseDesc').value;
      const valor = Number(document.getElementById('expenseValue').value);
      const categoria = document.getElementById('expenseCategory').value;
      const data = document.getElementById('expenseDate').value;
      if (!descricao || !valor || !categoria || !data) {
        alert('Preencha descrição, valor, categoria e data da despesa.');
        return;
      }
      const { error } = await supabase.from('despesas').insert([
        {
          projeto_id: getIdFromUrl(),
          descricao,
          valor,
          categoria,
          data,
        },
      ]);
      if (!error) {
        document.getElementById('expenseDesc').value = '';
        document.getElementById('expenseValue').value = '';
        document.getElementById('expenseCategory').value = 'material';
        document.getElementById('expenseDate').value = '';
        loadExpensesForProject(getIdFromUrl());
      } else {
        alert('Erro ao adicionar despesa.');
      }
    }

    async function loadIncomesForProject(projetoId) {
      const { data, error } = await supabase
        .from('receitas')
        .select('*')
        .eq('projeto_id', projetoId)
        .order('data', { ascending: false });
      if (!error) {
        projectIncomes = data;
        renderProjectIncomes();
      }
    }

    function renderProjectIncomes() {
      const list = document.getElementById('projectIncomesList');
      list.innerHTML = '';
      if (projectIncomes.length === 0) {
        list.innerHTML = '<li style="text-align:center; color:#888;">Nenhuma receita adicionada</li>';
        return;
      }
      projectIncomes.forEach((r) => {
        const item = document.createElement('li');
        item.innerHTML = `
          <div>
            <strong>${r.descricao}</strong>
            <br><small>${r.data || ''}</small>
          </div>
          <span class="value">R$${r.valor.toFixed(2)}</span>
        `;
        list.appendChild(item);
      });
    }

    async function addIncomeToProject() {
      const descricao = document.getElementById('incomeDesc').value;
      const valor = Number(document.getElementById('incomeValue').value);
      const data = document.getElementById('incomeDate').value;
      if (!descricao || !valor || !data) {
        alert('Preencha descrição, valor e data da receita.');
        return;
      }
      const { error } = await supabase.from('receitas').insert([
        {
          projeto_id: getIdFromUrl(),
          descricao,
          valor,
          data,
        },
      ]);
      if (!error) {
        document.getElementById('incomeDesc').value = '';
        document.getElementById('incomeValue').value = '';
        document.getElementById('incomeDate').value = '';
        loadIncomesForProject(getIdFromUrl());
      } else {
        alert('Erro ao adicionar receita.');
      }
    }

    document.getElementById('btn-add-expense').addEventListener('click', addExpenseToProject);
    document.getElementById('btn-add-income').addEventListener('click', addIncomeToProject);

    document.getElementById('projectFormPage').addEventListener('submit', saveProject);
    document.getElementById('btn-logout').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = 'index.html';
    });
    const id = getIdFromUrl();
    if (id) {
      loadProject(id);
      loadExpensesForProject(id);
      loadIncomesForProject(id);
    } else window.location.href = 'dashboard.html';
  </script>
</body>
</html>
