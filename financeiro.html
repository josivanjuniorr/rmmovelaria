<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Financeiro - Movelaria</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="main">
    <h2>Resumo Financeiro</h2>

    <div class="finance-summary-controls">
      <label for="filterMonth">Filtrar por mês:</label>
      <input type="month" id="filterMonth" />
    </div>

    <div class="summary-cards">
      <div class="card receitas-card">
        <h3>Total Receitas</h3>
        <p id="totalReceitas">R$ 0,00</p>
      </div>
      <div class="card despesas-card">
        <h3>Total Despesas</h3>
        <p id="totalDespesas">R$ 0,00</p>
      </div>
      <div class="card saldo-card">
        <h3>Saldo</h3>
        <p id="saldo">R$ 0,00</p>
      </div>
    </div>

    <!-- Botão e Lista -->
    <h3>Receitas</h3>
    <button id="btn-new-income">Nova Receita</button>
    <ul id="incomesList"></ul>

    <h3>Despesas</h3>
    <button id="btn-add-external-expense">Nova Despesa</button>
    <ul id="expensesList"></ul>

    <!-- Overlay e Modal de Receita -->
    <div id="overlay"></div>

    <div id="incomeForm" class="modal">
      <h3>Nova Receita</h3>
      <input type="text" id="incomeDesc" placeholder="Descrição" />
      <input type="number" id="incomeValue" placeholder="Valor (R$)" />
      <input type="date" id="incomeDate" />
      <div class="modal-actions">
        <button id="btn-save-income" class="save-btn">Salvar</button>
        <button id="btn-cancel-income" class="cancel-btn">Cancelar</button>
      </div>
    </div>

    <script type="module">
    // Importa sidebar.html
    fetch('sidebar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('sidebar').innerHTML = html;
        // Reativa botão logout
        const btnLogout = document.getElementById('btn-logout');
        if (btnLogout) {
          btnLogout.addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
          });
        }
      });
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://oncnehknyafxttztjteu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uY25laGtueWFmeHR0enRqdGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MjIzMjEsImV4cCI6MjA3MzI5ODMyMX0.qtqZAi48XqokjQOSn6hFcgVZZRlBk9UcFLeUJjTcA98';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Verificação de usuário logado
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'index.html';
      }
    })();

    const filterMonthInput = document.getElementById('filterMonth');
    const overlay = document.getElementById('overlay');
    const incomeForm = document.getElementById('incomeForm');

    async function loadFinanceData() {
      const { data: despesas } = await supabase.from('despesas').select('*');
      const { data: receitas } = await supabase.from('receitas').select('*');

      const filtroMes = filterMonthInput.value;

      const despesasFiltradas = filtroMes
        ? despesas.filter(d => d.data?.startsWith(filtroMes))
        : despesas;

      const receitasFiltradas = filtroMes
        ? receitas.filter(r => r.data?.startsWith(filtroMes))
        : receitas;

      const totalDespesas = despesasFiltradas.reduce((sum, d) => sum + Number(d.valor), 0);
      const totalReceitas = receitasFiltradas.reduce((sum, r) => sum + Number(r.valor), 0);
      const saldo = totalReceitas - totalDespesas;

      document.getElementById('totalReceitas').textContent = `R$ ${totalReceitas.toFixed(2)}`;
      document.getElementById('totalDespesas').textContent = `R$ ${totalDespesas.toFixed(2)}`;
      document.getElementById('saldo').textContent = `R$ ${saldo.toFixed(2)}`;

      // Renderiza receitas
      const incomesList = document.getElementById('incomesList');
      incomesList.innerHTML = '';
      if (receitasFiltradas.length === 0) incomesList.innerHTML = '<li>Nenhuma receita</li>';
      receitasFiltradas.forEach(r => {
        const li = document.createElement('li');
        li.textContent = `${r.data} | ${r.descricao} — R$${Number(r.valor).toFixed(2)}`;
        incomesList.appendChild(li);
      });

      // Renderiza despesas
      const expensesList = document.getElementById('expensesList');
      expensesList.innerHTML = '';
      if (despesasFiltradas.length === 0) expensesList.innerHTML = '<li>Nenhuma despesa</li>';
      despesasFiltradas.forEach(d => {
        const li = document.createElement('li');
        li.textContent = `${d.data} | ${d.categoria} | ${d.descricao} — R$${Number(d.valor).toFixed(2)}`;
        expensesList.appendChild(li);
      });
    }

    // Mostrar modal de receita
    document.getElementById('btn-new-income').addEventListener('click', () => {
      overlay.style.display = 'block';
      incomeForm.style.display = 'block';
      clearIncomeForm();
    });

    // Salvar receita
    document.getElementById('btn-save-income').addEventListener('click', async () => {
      const desc = document.getElementById('incomeDesc').value;
      const valor = parseFloat(document.getElementById('incomeValue').value);
      const data = document.getElementById('incomeDate').value;

      if (!desc || isNaN(valor) || !data) {
        alert('Preencha todos os campos corretamente.');
        return;
      }

      await supabase.from('receitas').insert([{
        descricao: desc,
        valor,
        data,
        projeto_id: null
      }]);

      closeIncomeForm();
      loadFinanceData();
    });

    // Cancelar modal
    document.getElementById('btn-cancel-income').addEventListener('click', closeIncomeForm);
    overlay.addEventListener('click', closeIncomeForm);

    function closeIncomeForm() {
      overlay.style.display = 'none';
      incomeForm.style.display = 'none';
    }

    function clearIncomeForm() {
      document.getElementById('incomeDesc').value = '';
      document.getElementById('incomeValue').value = '';
      document.getElementById('incomeDate').value = '';
    }

    filterMonthInput.addEventListener('change', loadFinanceData);

    loadFinanceData();
    </script>

</body>
</html>
