<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Financeiro - Movelaria</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="sidebar"></div>

  <div class="main">
    <h2>Resumo Financeiro</h2>

    <div class="finance-summary-controls">
      <label for="filterMonth">Filtrar por mês:</label>
      <input type="month" id="filterMonth" />
    </div>

    <div class="summary-cards">
      <div class="card receitas-card">
        <h3>Total Receitas</h3>
        <p id="totalReceitas">R$ 0,00</p>
      </div>
      <div class="card despesas-card">
        <h3>Total Despesas</h3>
        <p id="totalDespesas">R$ 0,00</p>
      </div>
      <div class="card saldo-card">
        <h3>Saldo</h3>
        <p id="saldo">R$ 0,00</p>
      </div>
      <div class="card caixa-card">
        <h3>Caixa</h3>
        <p id="caixa">R$ 0,00</p>
      </div>
    </div>

    <!-- Botão e Lista -->
    <div class="cards-row">
      <div>
        <h3>Receitas</h3>
        <button id="btn-new-income">Nova Receita</button>
        <div id="incomesList" class="cards-list"></div>
      </div>
      <div>
        <h3>Despesas</h3>
          <button id="btn-new-expense">Nova Despesa</button>
        <div id="expensesList" class="cards-list"></div>
      </div>
    </div>

    <!-- Overlay e Modais -->
    <div id="overlay"></div>

    <div id="incomeForm" class="modal">
      <h3>Nova Receita</h3>
      <input type="text" id="incomeDesc" placeholder="Descrição" />
      <input type="number" id="incomeValue" placeholder="Valor (R$)" />
      <input type="date" id="incomeDate" />
      <div class="modal-actions">
        <button id="btn-save-income" class="save-btn">Salvar</button>
        <button id="btn-cancel-income" class="cancel-btn">Cancelar</button>
      </div>
    </div>

    <div id="expenseForm" class="modal">
      <h3>Nova Despesa</h3>
      <input type="text" id="expenseDesc" placeholder="Descrição" />
      <input type="text" id="expenseCat" placeholder="Categoria" />
      <input type="number" id="expenseValue" placeholder="Valor (R$)" />
      <input type="date" id="expenseDate" />
      <div class="modal-actions">
        <button id="btn-save-expense" class="save-btn">Salvar</button>
        <button id="btn-cancel-expense" class="cancel-btn">Cancelar</button>
      </div>
    </div>

    <script type="module">
    // Importa sidebar.html
    fetch('sidebar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('sidebar').innerHTML = html;
        // Reativa botão logout
        const btnLogout = document.getElementById('btn-logout');
        if (btnLogout) {
          btnLogout.addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
          });
        }
        // Adiciona eventListener do botão de esconder sidebar
        const btnToggleSidebar = document.getElementById('btn-toggle-sidebar');
        const sidebarDiv = document.querySelector('.sidebar');
        const iconToggle = document.getElementById('icon-toggle');
        let sidebarMinimized = false;
        btnToggleSidebar.addEventListener('click', () => {
          sidebarMinimized = !sidebarMinimized;
          if (sidebarMinimized) {
            sidebarDiv.classList.add('minimized');
            iconToggle.innerHTML = '<path d="M6 6l6 6 6-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
          } else {
            sidebarDiv.classList.remove('minimized');
            iconToggle.innerHTML = '<path d="M6 12l6 6 6-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>';
          }
        });
      });
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://oncnehknyafxttztjteu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uY25laGtueWFmeHR0enRqdGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MjIzMjEsImV4cCI6MjA3MzI5ODMyMX0.qtqZAi48XqokjQOSn6hFcgVZZRlBk9UcFLeUJjTcA98';
    const supabase = createClient(supabaseUrl, supabaseKey);

    // Verificação de usuário logado
    (async () => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'index.html';
      }
    })();

  const filterMonthInput = document.getElementById('filterMonth');
  const overlay = document.getElementById('overlay');
  const incomeForm = document.getElementById('incomeForm');

  // Define filtro do mês atual ao carregar
  const now = new Date();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const year = now.getFullYear();
  filterMonthInput.value = `${year}-${month}`;

    async function loadFinanceData() {
      // Busca projetos para exibir nome
      const { data: projetos } = await supabase.from('projetos').select('id, titulo');
      const { data: despesas } = await supabase.from('despesas').select('*');
      const { data: receitas } = await supabase.from('receitas').select('*');

      const filtroMes = filterMonthInput.value;

      const despesasFiltradas = filtroMes
        ? despesas.filter(d => d.data?.startsWith(filtroMes))
        : despesas;

      const receitasFiltradas = filtroMes
        ? receitas.filter(r => r.data?.startsWith(filtroMes))
        : receitas;

      const totalDespesas = despesasFiltradas.reduce((sum, d) => sum + Number(d.valor), 0);
      const totalReceitas = receitasFiltradas.reduce((sum, r) => sum + Number(r.valor), 0);
      const saldo = totalReceitas - totalDespesas;

      // Calcula caixa: saldo acumulado dos meses anteriores + saldo do mês atual
      let caixa = saldo;
      if (filterMonthInput.value) {
        const [anoAtual, mesAtual] = filterMonthInput.value.split('-').map(Number);
        // Soma saldo de todos os meses anteriores
        let saldoAnterior = 0;
        for (let ano = 2000; ano <= anoAtual; ano++) {
          for (let mes = 1; mes <= (ano === anoAtual ? mesAtual - 1 : 12); mes++) {
            const mesStr = String(mes).padStart(2, '0');
            const filtro = `${ano}-${mesStr}`;
            const receitasMes = receitas.filter(r => r.data?.startsWith(filtro));
            const despesasMes = despesas.filter(d => d.data?.startsWith(filtro));
            const saldoMes = receitasMes.reduce((sum, r) => sum + Number(r.valor), 0) - despesasMes.reduce((sum, d) => sum + Number(d.valor), 0);
            saldoAnterior += saldoMes;
          }
        }
        caixa += saldoAnterior;
      }

      document.getElementById('totalReceitas').textContent = `R$ ${totalReceitas.toFixed(2)}`;
      document.getElementById('totalDespesas').textContent = `R$ ${totalDespesas.toFixed(2)}`;
      document.getElementById('saldo').textContent = `R$ ${saldo.toFixed(2)}`;
      document.getElementById('caixa').textContent = `R$ ${caixa.toFixed(2)}`;

      // Renderiza receitas
      const incomesList = document.getElementById('incomesList');
      incomesList.innerHTML = '';
      if (receitasFiltradas.length === 0) {
        incomesList.innerHTML = '<div class="card-item empty">Nenhuma receita</div>';
      } else {
        receitasFiltradas.forEach(r => {
          const projeto = r.projeto_id ? projetos.find(p => p.id === r.projeto_id) : null;
          const projetoNome = projeto ? projeto.titulo : '—';
          const card = document.createElement('div');
          card.className = 'card-item receita';
          card.innerHTML = `
            <div class="card-item-header">
              <span class="card-item-date">${r.data}</span>
              <span class="card-item-value">R$${Number(r.valor).toFixed(2)}</span>
            </div>
            <div class="card-item-desc">${r.descricao}</div>
            <div class="card-item-projeto">Projeto: <b>${projetoNome}</b></div>
          `;
          incomesList.appendChild(card);
        });
      }

      const expensesList = document.getElementById('expensesList');
      expensesList.innerHTML = '';
      if (despesasFiltradas.length === 0) {
        expensesList.innerHTML = '<div class="card-item empty">Nenhuma despesa</div>';
      } else {
        despesasFiltradas.forEach(d => {
          const projeto = d.projeto_id ? projetos.find(p => p.id === d.projeto_id) : null;
          const projetoNome = projeto ? projeto.titulo : '—';
          const card = document.createElement('div');
          card.className = 'card-item despesa';
          card.innerHTML = `
            <div class="card-item-header">
              <span class="card-item-date">${d.data}</span>
              <span class="card-item-value">R$${Number(d.valor).toFixed(2)}</span>
            </div>
            <div class="card-item-desc">${d.categoria} | ${d.descricao}</div>
            <div class="card-item-projeto">Projeto: <b>${projetoNome}</b></div>
          `;
          expensesList.appendChild(card);
        });
      }

    }


    // Mostrar modal de receita
    document.getElementById('btn-new-income').addEventListener('click', () => {
      overlay.style.display = 'block';
      incomeForm.style.display = 'block';
      clearIncomeForm();
    });

    // Mostrar modal de despesa
    document.getElementById('btn-new-expense').addEventListener('click', () => {
      overlay.style.display = 'block';
      expenseForm.style.display = 'block';
      clearExpenseForm();
    });

    // Salvar receita
    document.getElementById('btn-save-income').addEventListener('click', async () => {
      const desc = document.getElementById('incomeDesc').value;
      const valor = parseFloat(document.getElementById('incomeValue').value);
      const data = document.getElementById('incomeDate').value;

      if (!desc || isNaN(valor) || !data) {
        alert('Preencha todos os campos corretamente.');
        return;
      }

      const { error } = await supabase.from('receitas').insert([
        {
          descricao: desc,
          valor,
          data,
          projeto_id: null
        }
      ]);

      if (error) {
        alert('Erro ao salvar receita: ' + error.message);
        return;
      }

      closeIncomeForm();
      loadFinanceData();
    });

    // Salvar despesa
    document.getElementById('btn-save-expense').addEventListener('click', async () => {
      const desc = document.getElementById('expenseDesc').value;
      const cat = document.getElementById('expenseCat').value;
      const valor = parseFloat(document.getElementById('expenseValue').value);
      const data = document.getElementById('expenseDate').value;

      if (!desc || !cat || isNaN(valor) || !data) {
        alert('Preencha todos os campos corretamente.');
        return;
      }

      await supabase.from('despesas').insert([
        {
          descricao: desc,
          categoria: cat,
          valor,
          data,
          projeto_id: null
        }
      ]);

      closeExpenseForm();
      loadFinanceData();
    });

    // Cancelar modais
    document.getElementById('btn-cancel-income').addEventListener('click', closeIncomeForm);
    document.getElementById('btn-cancel-expense').addEventListener('click', closeExpenseForm);
    overlay.addEventListener('click', () => {
      closeIncomeForm();
      closeExpenseForm();
    });

    function closeIncomeForm() {
      overlay.style.display = 'none';
      incomeForm.style.display = 'none';
    }
    function closeExpenseForm() {
      overlay.style.display = 'none';
      expenseForm.style.display = 'none';
    }
    function clearIncomeForm() {
      document.getElementById('incomeDesc').value = '';
      document.getElementById('incomeValue').value = '';
      document.getElementById('incomeDate').value = '';
    }
    function clearExpenseForm() {
      document.getElementById('expenseDesc').value = '';
      document.getElementById('expenseCat').value = '';
      document.getElementById('expenseValue').value = '';
      document.getElementById('expenseDate').value = '';
    }

    filterMonthInput.addEventListener('change', loadFinanceData);

    loadFinanceData();
    </script>

</body>
</html>
