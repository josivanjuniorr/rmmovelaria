<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Dashboard - Movelaria</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h1>RA Movelaria</h1>
    <a href="#">Dashboard</a>
    <a href="#">Clientes</a>
    <a href="financeiro.html">Financeiro</a>
    <a href="#" id="btn-logout">Sair</a>
  </div>

  <!-- Conteúdo Principal -->
  <div class="main">
    <h2>Projetos</h2>
    <div style="margin-bottom:15px;">
      <button id="btn-new-project">Novo Projeto</button>
    </div>

    <div class="project-controls">
      <input
        type="text"
        id="filterInput"
        placeholder="Buscar por título ou cliente..."
      />
      <select id="perPageSelect">
        <option value="5">5 por página</option>
        <option value="10" selected>10 por página</option>
        <option value="20">20 por página</option>
      </select>
    </div>

    <div id="pagination" class="pagination"></div>
    <div id="cardsContainer" class="cards-container"></div>
  </div>



  <!-- JavaScript -->
  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabase = createClient(
      'https://oncnehknyafxttztjteu.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uY25laGtueWFmeHR0enRqdGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3MjIzMjEsImV4cCI6MjA3MzI5ODMyMX0.qtqZAi48XqokjQOSn6hFcgVZZRlBk9UcFLeUJjTcA98'
    );

    let projects = [];
    let filteredProjects = [];
    let editId = null;
    let projectExpenses = [];

  // overlay removido
    let currentPage = 1;
    let perPage = 10;

    // Filtro e paginação
    document.getElementById('filterInput').addEventListener('input', () => {
      const search = document.getElementById('filterInput').value.toLowerCase();
      filteredProjects = projects.filter(
        (p) =>
          p.titulo.toLowerCase().includes(search) ||
          p.cliente.toLowerCase().includes(search)
      );
      currentPage = 1;
      renderCards();
    });

    document.getElementById('perPageSelect').addEventListener('change', () => {
      perPage = Number(document.getElementById('perPageSelect').value);
      currentPage = 1;
      renderCards();
    });

    async function checkAuth() {
      const {
        data: { session },
      } = await supabase.auth.getSession();
      if (!session) window.location.href = 'index.html';
      else loadProjects();
    }

    async function logout() {
      await supabase.auth.signOut();
      window.location.href = 'index.html';
    }

    async function loadProjects() {
      const { data: projectsData, error: projectsError } = await supabase
        .from('projetos')
        .select('*')
        .order('created_at', { ascending: false });

      if (!projectsError) {
        projects = projectsData;
        filteredProjects = [...projects];

        // Carrega todas as receitas de todos os projetos
        const { data: incomesData, error: incomesError } = await supabase
          .from('receitas')
          .select('*');

        if (!incomesError) {
          projectIncomes = incomesData; // atualiza a variável global
        } else {
          console.error('Erro ao carregar receitas:', incomesError);
        }
      }

      renderCards();
    }

    // Funções do modal removidas

    // Garante que os cards sejam renderizados após carregar os projetos
    function renderCardsWrapper() {
      if (Array.isArray(filteredProjects)) {
        renderCards();
      } else {
        filteredProjects = [];
        renderCards();
      }
    }

    // Chama o carregamento inicial dos projetos
    checkAuth();

    async function deleteProject(id) {
      if (confirm('Deseja realmente excluir este projeto?')) {
        await supabase.from('projetos').delete().eq('id', id);
        loadProjects();
      }
    }

    async function loadExpensesForProject(projetoId) {
      const { data, error } = await supabase
        .from('despesas')
        .select('*')
        .eq('projeto_id', projetoId)
        .order('data', { ascending: false });

      if (!error) {
        projectExpenses = data;
        renderProjectExpenses();
      }
    }

    function renderProjectExpenses() {
      const list = document.getElementById('projectExpensesList');
      list.innerHTML = '';

      if (projectExpenses.length === 0) {
        list.innerHTML = '<li style="text-align:center; color:#888;">Nenhuma despesa adicionada</li>';
        return;
      }

      projectExpenses.forEach((e) => {
        const item = document.createElement('li');
        const formattedDate = e.data ? new Date(e.data).toLocaleDateString() : '';
        item.innerHTML = `
          <div>
            <strong>${e.descricao}</strong> 
            <span class="category">${e.categoria}</span>
            <br><small>${formattedDate}</small>
          </div>
          <span class="value">R$${e.valor.toFixed(2)}</span>
        `;
        list.appendChild(item);
      });
    }

    async function addExpenseToProject() {
      const descricao = document.getElementById('expenseDesc').value;
      const valor = Number(document.getElementById('expenseValue').value);
      const categoria = document.getElementById('expenseCategory').value;
      const data = document.getElementById('expenseDate').value;

      if (!descricao || !valor || !categoria || !data) {
        alert('Preencha descrição, valor, categoria e data da despesa.');
        return;
      }

      const { data: inserted, error } = await supabase.from('despesas').insert([
        {
          projeto_id: editId,
          descricao,
          valor,
          categoria,
          data,
        },
      ]);

      if (!error) {
        document.getElementById('expenseDesc').value = '';
        document.getElementById('expenseValue').value = '';
        document.getElementById('expenseCategory').value = 'material';
        document.getElementById('expenseDate').value = '';
        loadExpensesForProject(editId);
      } else {
        alert('Erro ao adicionar despesa: ' + error.message);
      }
    }


    let projectIncomes = [];

    // Carregar receitas de um projeto
    async function loadIncomesForProject(projetoId) {
      const { data, error } = await supabase
        .from('receitas')
        .select('*')
        .eq('projeto_id', projetoId)
        .order('data', { ascending: false });

      if (!error) {
        projectIncomes = data;
        renderProjectIncomes();
      }
    }

    // Renderizar receitas
    function renderProjectIncomes() {
      const list = document.getElementById('projectIncomesList');
      list.innerHTML = '';

      if (projectIncomes.length === 0) {
        list.innerHTML = '<li style="text-align:center; color:#888;">Nenhuma receita adicionada</li>';
        return;
      }

      projectIncomes.forEach((r) => {
        const item = document.createElement('li');
        item.innerHTML = `
          <div>
            <strong>${r.descricao}</strong>
            <br><small>${r.data || ''}</small>
          </div>
          <span class="value">R$${r.valor.toFixed(2)}</span>
        `;
        list.appendChild(item);
      });
    }

    // Adicionar receita
    async function addIncomeToProject() {
      const descricao = document.getElementById('incomeDesc').value;
      const valor = Number(document.getElementById('incomeValue').value);
      const data = document.getElementById('incomeDate').value;

      if (!descricao || !valor || !data) {
        alert('Preencha descrição, valor e data da receita.');
        return;
      }

      const { data: inserted, error } = await supabase.from('receitas').insert([
        {
          projeto_id: editId,
          descricao,
          valor,
          data,
        },
      ]);

      if (!error) {
        document.getElementById('incomeDesc').value = '';
        document.getElementById('incomeValue').value = '';
        document.getElementById('incomeDate').value = '';
        loadIncomesForProject(editId);
      } else {
        alert('Erro ao adicionar receita: ' + error.message);
      }
    }

    // Vincula evento ao botão
    document.getElementById('btn-add-income').addEventListener('click', addIncomeToProject);




    async function renderCards() {
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';

      const today = new Date();

      // Calcula valor a receber para cada projeto
      filteredProjects.forEach(p => {
        if (p.prazo) {
          const prazoDate = new Date(p.prazo);
          p.daysLeft = Math.ceil((prazoDate - today) / (1000 * 60 * 60 * 24));
        } else {
          p.daysLeft = null;
        }

        // Calcula total de receitas do projeto
        const receitasDoProjeto = projectIncomes.filter(r => r.projeto_id === p.id);
        const totalRecebido = receitasDoProjeto.reduce((sum, r) => sum + Number(r.valor), 0);
        p.valorAReceber = (p.valor_total ?? 0) - totalRecebido;
      });

      filteredProjects = ordenarProjetosPrioridade(filteredProjects);

      const start = (currentPage - 1) * perPage;
      const end = start + perPage;
      const pageItems = filteredProjects.slice(start, end);

      const deliverModal = document.getElementById('deliverModal');
      const btnYes = document.getElementById('btn-deliver-yes');
      const btnNo = document.getElementById('btn-deliver-no');
      let currentProjectId = null;

      pageItems.forEach((p) => {
        const card = document.createElement('div');
        card.className = 'project-card';
        let formattedDate = '';
        if (p.prazo) {
          const d = new Date(p.prazo);
          formattedDate = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2,'0')}/${d.getFullYear()}`;
        }
        let prazoMsg = '';
        if (p.status === 'producao' && p.daysLeft !== null) {
          if (p.daysLeft < 0) {
            prazoMsg = `<span class="warning warning-red">Projeto atrasado há ${Math.abs(p.daysLeft)} dias.</span>`;
          } else {
            prazoMsg = `<span class="warning warning-yellow">Faltam ${p.daysLeft} dias para o prazo.</span>`;
          }
        }
        const statusClass =
          p.status === 'producao'
            ? 'status-badge status-producao'
            : p.status === 'entregue'
            ? 'status-badge status-entregue'
            : 'status-badge status-pagamento';
        card.innerHTML = `
          <div class="card-header">
            <h4>${p.titulo}</h4>
            <span class="${statusClass}">
              ${p.status === 'producao' ? 'Produção' : p.status === 'entregue' ? 'Entregue' : 'Pagamento pendente'}
            </span>
          </div>
          <p><strong>Cliente:</strong> ${p.cliente}</p>
          <p>${p.descricao}</p>
          <div class="info">
            <div><strong>Prazo:</strong> ${formattedDate}</div>
            <div><strong>Total:</strong> R$${p.valor_total ?? 0}</div>
          </div>
          <div class="info"><strong>Valor a receber:</strong> R$${p.valorAReceber.toFixed(2)}</div>
          ${prazoMsg}
        `;
        card.addEventListener('click', () => {
          window.location.href = `projeto.html?id=${p.id}`;
        });
        container.appendChild(card);
      });

      renderPagination();

      btnYes.onclick = async () => {
        await supabase.from('projetos').update({ status: 'entregue' }).eq('id', currentProjectId);
        deliverModal.style.display = 'none';
        loadProjects();
      };

      btnNo.onclick = async () => {
        await supabase.from('projetos').update({ status: 'pagamento' }).eq('id', currentProjectId);
        deliverModal.style.display = 'none';
        loadProjects();
      };

      deliverModal.onclick = (e) => {
        if (e.target === deliverModal) deliverModal.style.display = 'none';
      };
    }

    function ordenarProjetosPrioridade(projetos) {
      const hoje = new Date();

      return projetos.slice().sort((a, b) => {
        // Projetos entregues ou pendentes vão pro final
        const statusA = (a.status === 'pagamento' || a.status === 'entregue') ? 1 : 0;
        const statusB = (b.status === 'pagamento' || b.status === 'entregue') ? 1 : 0;
        if (statusA !== statusB) return statusA - statusB;

        // Converte prazos para datas
        const prazoA = a.prazo ? new Date(a.prazo) : null;
        const prazoB = b.prazo ? new Date(b.prazo) : null;

        // Calcula dias de atraso ou dias restantes
        const diasA = prazoA ? Math.ceil((prazoA - hoje) / (1000 * 60 * 60 * 24)) : null;
        const diasB = prazoB ? Math.ceil((prazoB - hoje) / (1000 * 60 * 60 * 24)) : null;

        // Função para definir categoria de prioridade:
        // 0: atrasado (dias < 0)
        // 1: próximo do prazo (0 <= dias <= 7)
        // 2: prazo longe ou indefinido
        function categoria(dias) {
          if (dias === null) return 2;
          if (dias < 0) return 0;
          if (dias <= 7) return 1;
          return 2;
        }

        const catA = categoria(diasA);
        const catB = categoria(diasB);

        // Prioriza pela categoria
        if (catA !== catB) return catA - catB;

        // Dentro da mesma categoria, ordena:
        if (catA === 0) return diasA - diasB; // mais atrasado primeiro
        if (catA === 1) return diasA - diasB;
        if (catA === 2) {
          if (diasA === null && diasB === null) return 0;
          if (diasA === null) return 1;
          if (diasB === null) return -1;
          return diasA - diasB;
        }

        return 0;
      });
    }



    function renderPagination() {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      const totalPages = Math.ceil(filteredProjects.length / perPage);
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.classList.add('active');
        btn.addEventListener('click', () => {
          currentPage = i;
          renderCards();
        });
        pagination.appendChild(btn);
      }
    }

    // Eventos
    document.getElementById('btn-new-project').addEventListener('click', () => {
      window.location.href = 'projeto.html';
    });

    // Garante que os cards sejam renderizados após carregar os projetos
    function renderCardsWrapper() {
      if (Array.isArray(filteredProjects)) {
        renderCards();
      } else {
        filteredProjects = [];
        renderCards();
      }
    }

    // Chama o carregamento inicial dos projetos
    checkAuth();
    document.getElementById('btn-logout').addEventListener('click', logout);

    checkAuth();
  </script>
</body>
</html>
